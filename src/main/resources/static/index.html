<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #10b981;
            --bg-light: #f9fafb;
            --bg-dark: #1f2937;
            --text-color: #1f2937;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .card {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease-in-out;
        }

        .btn-primary {
            background-color: var(--primary-color);
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        #expense-list > div {
            transition: all 0.3s ease-in-out;
        }

        .hidden-view {
            display: none;
        }

        .main-container {
            max-width: 90vw;
        }

        @media (min-width: 1024px) {
            .main-container {
                max-width: 1200px;
            }
        }

        .loading {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="app-container" class="main-container p-4 lg:p-8">

        <!-- AUTH View -->
        <div id="auth-view" class="w-full max-w-md mx-auto hidden-view">
            <div class="card p-8 sm:p-10">
                <h1 id="auth-title" class="text-3xl font-bold mb-6 text-center text-gray-800">Welcome Back</h1>

                <form id="auth-form" class="space-y-6">
                    <div id="username-field" class="hidden">
                        <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                        <input type="text" id="username" name="username" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="email" name="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="password" name="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div id="auth-message" class="text-sm font-medium"></div>

                    <button type="submit" id="auth-button" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Sign In
                    </button>
                </form>

                <div class="mt-6 text-center">
                    <button id="toggle-auth-mode" class="text-sm text-blue-500 hover:text-blue-700">
                        Need an account? Register
                    </button>
                </div>
            </div>
        </div>

        <!-- DASHBOARD View -->
        <div id="dashboard-view" class="hidden-view w-full">
            <header class="flex justify-between items-center mb-8 p-4 lg:p-0">
                <h2 class="text-3xl font-extrabold text-gray-800">
                    Welcome, <span id="user-name" class="text-blue-600">User</span>!
                </h2>
                <div class="flex space-x-4 items-center">
                    <button id="add-expense-btn" class="flex items-center space-x-2 py-2 px-4 rounded-lg text-white btn-primary shadow-lg shadow-blue-300/50">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        <span>Add Expense</span>
                    </button>
                    <button id="logout-btn" class="text-gray-500 hover:text-red-500 transition duration-150">
                        Logout
                    </button>
                </div>
            </header>

            <!-- Summary Card -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="card p-6 text-center bg-white border-b-4 border-blue-500">
                    <p class="text-sm font-medium text-gray-500">Total Expenses</p>
                    <p id="total-expenses" class="text-4xl font-extrabold text-gray-900 mt-1">₹ 0.00</p>
                </div>
                <div class="card p-6 text-center bg-white border-b-4 border-emerald-500">
                    <p class="text-sm font-medium text-gray-500">Latest Month Spend</p>
                    <p id="month-spend" class="text-4xl font-extrabold text-gray-900 mt-1">₹ 0.00</p>
                </div>
                <div class="card p-6 text-center bg-white border-b-4 border-yellow-500">
                    <p class="text-sm font-medium text-gray-500">Categories Count</p>
                    <p id="category-count" class="text-4xl font-extrabold text-gray-900 mt-1">0</p>
                </div>
            </div>

            <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Expense List Section -->
                <div class="lg:col-span-2">
                    <div class="card p-6">
                        <h3 class="text-xl font-semibold mb-4 text-gray-800">Recent Transactions</h3>
                        <div id="expense-list" class="space-y-4">
                            <div id="no-expenses-message" class="text-center py-10 text-gray-500 italic">
                                Loading expenses...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Expense Form Section -->
                <div class="lg:col-span-1">
                    <div id="expense-form-container" class="card p-6 sticky top-8 hidden">
                        <h3 id="form-title" class="text-xl font-semibold mb-4 text-gray-800">Add New Expense</h3>
                        <form id="expense-form" class="space-y-4">
                            <div>
                                <label for="expense-description" class="block text-sm font-medium text-gray-700">Description</label>
                                <input type="text" id="expense-description" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-secondary-color focus:border-secondary-color">
                            </div>
                            <div>
                                <label for="expense-amount" class="block text-sm font-medium text-gray-700">Amount (₹)</label>
                                <input type="number" id="expense-amount" required min="0.01" step="0.01" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-secondary-color focus:border-secondary-color">
                            </div>
                            <div>
                                <label for="expense-category" class="block text-sm font-medium text-gray-700">Category</label>
                                <select id="expense-category" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-secondary-color focus:border-secondary-color">
                                    <option value="Food">Food</option>
                                    <option value="Transport">Transport</option>
                                    <option value="Utilities">Utilities</option>
                                    <option value="Entertainment">Entertainment</option>
                                    <option value="Shopping">Shopping</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label for="expense-date" class="block text-sm font-medium text-gray-700">Date</label>
                                <input type="date" id="expense-date" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-secondary-color focus:border-secondary-color">
                            </div>

                            <button type="submit" id="form-submit-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-emerald-500 hover:bg-emerald-600 transition duration-150">
                                Save Expense
                            </button>
                            <button type="button" id="form-cancel-btn" class="w-full mt-2 py-2 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition duration-150">
                                Cancel
                            </button>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

<script>
    // Configuration
    const API_BASE = '/api';
    const VIEWS = {
        AUTH: 'auth-view',
        DASHBOARD: 'dashboard-view',
    };
    
    let state = {
        mode: 'login',
        token: localStorage.getItem('authToken') || null,
        userId: localStorage.getItem('userId') || null,
        username: localStorage.getItem('username') || 'User',
        expenses: [],
        currentExpenseId: null
    };

    // DOM Elements
    const authView = document.getElementById(VIEWS.AUTH);
    const dashboardView = document.getElementById(VIEWS.DASHBOARD);
    const authForm = document.getElementById('auth-form');
    const toggleAuthBtn = document.getElementById('toggle-auth-mode');
    const authTitle = document.getElementById('auth-title');
    const authBtn = document.getElementById('auth-button');
    const usernameField = document.getElementById('username-field');
    const authMessage = document.getElementById('auth-message');
    const userNameDisplay = document.getElementById('user-name');
    const logoutBtn = document.getElementById('logout-btn');
    const expenseList = document.getElementById('expense-list');
    const expenseFormContainer = document.getElementById('expense-form-container');
    const expenseForm = document.getElementById('expense-form');
    const addExpenseBtn = document.getElementById('add-expense-btn');
    const formCancelBtn = document.getElementById('form-cancel-btn');
    const formTitle = document.getElementById('form-title');
    const formSubmitBtn = document.getElementById('form-submit-btn');
    const totalExpensesEl = document.getElementById('total-expenses');
    const monthSpendEl = document.getElementById('month-spend');
    const categoryCountEl = document.getElementById('category-count');
    const noExpensesMsg = document.getElementById('no-expenses-message');

    // Utility Functions
    async function fetchApi(endpoint, options = {}) {
        const headers = {
            'Content-Type': 'application/json',
            ...options.headers
        };

        if (state.token) {
            headers['Authorization'] = `Bearer ${state.token}`;
        }

        try {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers,
            });

            // Handle unauthorized
            if (response.status === 401 || response.status === 403) {
                handleLogout();
                throw new Error('Session expired. Please login again.');
            }

            // Handle other errors
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || `HTTP ${response.status}`);
            }

            // Check if response has content
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return await response.json();
            }
            
            return await response.text();
        } catch (error) {
            console.error('API Error:', error);
            throw error;
        }
    }

    function toggleAuthMode() {
        if (state.mode === 'login') {
            state.mode = 'register';
            authTitle.textContent = 'Create Account';
            authBtn.textContent = 'Register';
            toggleAuthBtn.textContent = 'Already have an account? Sign In';
            usernameField.classList.remove('hidden');
        } else {
            state.mode = 'login';
            authTitle.textContent = 'Welcome Back';
            authBtn.textContent = 'Sign In';
            toggleAuthBtn.textContent = 'Need an account? Register';
            usernameField.classList.add('hidden');
        }
        authMessage.textContent = '';
    }
    
    function showView(view) {
        authView.classList.add('hidden-view');
        dashboardView.classList.add('hidden-view');

        if (view === VIEWS.AUTH) {
            authView.classList.remove('hidden-view');
            if (state.mode !== 'login') {
                state.mode = 'register';
                toggleAuthMode();
            }
            expenseForm.reset();
            hideExpenseForm();
        } else {
            dashboardView.classList.remove('hidden-view');
            userNameDisplay.textContent = state.username;
            fetchAndRenderExpenses();
        }
    }

    function getCategoryColor(category) {
        const colors = {
            'Food': 'bg-red-100 text-red-800',
            'Transport': 'bg-blue-100 text-blue-800',
            'Utilities': 'bg-yellow-100 text-yellow-800',
            'Entertainment': 'bg-purple-100 text-purple-800',
            'Shopping': 'bg-pink-100 text-pink-800',
            'Other': 'bg-gray-100 text-gray-800'
        };
        return colors[category] || colors['Other'];
    }

    function renderExpense(expense) {
        const colorClass = getCategoryColor(expense.category);
        const date = new Date(expense.date);
        const formattedDate = date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });

        const expenseItem = document.createElement('div');
        expenseItem.className = 'flex justify-between items-center p-4 bg-white hover:bg-gray-50 rounded-xl shadow-sm border border-gray-100';
        expenseItem.innerHTML = `
            <div class="flex items-center space-x-4">
                <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full ${colorClass}">
                    ${expense.category}
                </span>
                <div>
                    <p class="text-sm font-medium text-gray-900">${expense.description}</p>
                    <p class="text-xs text-gray-500 mt-0.5">${formattedDate}</p>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <p class="text-lg font-bold text-red-600">₹ ${parseFloat(expense.amount).toFixed(2)}</p>
                <button data-id="${expense.id}" data-action="edit" class="text-blue-500 hover:text-blue-700 transition duration-150">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                </button>
                <button data-id="${expense.id}" data-action="delete" class="text-red-500 hover:text-red-700 transition duration-150">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
            </div>
        `;
        return expenseItem;
    }

    function renderExpenses() {
        // Clear list except the no-expenses message
        while (expenseList.children.length > 1) {
            expenseList.removeChild(expenseList.lastChild);
        }

        if (state.expenses.length === 0) {
            noExpensesMsg.textContent = 'No expenses recorded yet. Start adding your first expense!';
            noExpensesMsg.classList.remove('hidden');
            updateSummary();
            return;
        }

        noExpensesMsg.classList.add('hidden');
        
        // Sort by date descending
        const sortedExpenses = [...state.expenses].sort((a, b) => new Date(b.date) - new Date(a.date));
        
        sortedExpenses.forEach(expense => {
            expenseList.appendChild(renderExpense(expense));
        });
        
        updateSummary();
    }

    function updateSummary() {
        const total = state.expenses.reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
        totalExpensesEl.textContent = `₹ ${total.toFixed(2)}`;

        const lastMonth = new Date();
        lastMonth.setMonth(lastMonth.getMonth() - 1);
        
        const monthTotal = state.expenses
            .filter(exp => new Date(exp.date) > lastMonth)
            .reduce((sum, exp) => sum + parseFloat(exp.amount || 0), 0);
        monthSpendEl.textContent = `₹ ${monthTotal.toFixed(2)}`;

        const categories = new Set(state.expenses.map(exp => exp.category));
        categoryCountEl.textContent = categories.size;
    }

    function showExpenseForm(isEdit = false, expense = {}) {
        expenseFormContainer.classList.remove('hidden');
        state.currentExpenseId = isEdit ? expense.id : null;
        formTitle.textContent = isEdit ? 'Edit Expense' : 'Add New Expense';
        formSubmitBtn.textContent = isEdit ? 'Update Expense' : 'Save Expense';
        
        document.getElementById('expense-description').value = expense.description || '';
        document.getElementById('expense-amount').value = expense.amount || '';
        document.getElementById('expense-category').value = expense.category || 'Food';
        document.getElementById('expense-date').value = expense.date || new Date().toISOString().split('T')[0];
    }

    function hideExpenseForm() {
        expenseFormContainer.classList.add('hidden');
        expenseForm.reset();
        state.currentExpenseId = null;
    }

    // Event Handlers
    async function handleAuth(event) {
        event.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const username = document.getElementById('username').value;
        
        authMessage.textContent = 'Processing...';
        authMessage.className = 'text-sm font-medium text-blue-600';

        try {
            let result;
            if (state.mode === 'register') {
                result = await fetchApi('/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({ username, email, password })
                });
            } else {
                result = await fetchApi('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
            }

            state.token = result.token;
            state.userId = result.userId;
            state.username = result.username;

            localStorage.setItem('authToken', state.token);
            localStorage.setItem('userId', state.userId);
            localStorage.setItem('username', state.username);
            
            authMessage.textContent = 'Success! Redirecting...';
            authMessage.className = 'text-sm font-medium text-green-600';
            
            setTimeout(() => {
                showView(VIEWS.DASHBOARD);
                authForm.reset();
                authMessage.textContent = '';
            }, 500);

        } catch (error) {
            authMessage.textContent = error.message || 'Authentication failed';
            authMessage.className = 'text-sm font-medium text-red-600';
        }
    }

    function handleLogout() {
        state.token = null;
        state.userId = null;
        state.username = 'User';
        state.expenses = [];
        localStorage.removeItem('authToken');
        localStorage.removeItem('userId');
        localStorage.removeItem('username');
        showView(VIEWS.AUTH);
    }
    
    async function fetchAndRenderExpenses() {
        noExpensesMsg.textContent = 'Loading expenses...';
        noExpensesMsg.classList.remove('hidden');
        
        try {
            const expenses = await fetchApi('/expenses', { method: 'GET' });
            state.expenses = Array.isArray(expenses) ? expenses : [];
            renderExpenses();
        } catch (error) {
            console.error("Error fetching expenses:", error);
            noExpensesMsg.textContent = 'Failed to load expenses. ' + error.message;
            noExpensesMsg.classList.remove('hidden');
        }
    }
    
    async function handleExpenseSubmit(event) {
        event.preventDefault();
        
        const description = document.getElementById('expense-description').value;
        const amount = document.getElementById('expense-amount').value;
        const category = document.getElementById('expense-category').value;
        const date = document.getElementById('expense-date').value;

        const expensePayload = {
            description,
            amount: parseFloat(amount),
            category,
            date
        };

        try {
            if (state.currentExpenseId) {
                await fetchApi(`/expenses/${state.currentExpenseId}`, {
                    method: 'PUT',
                    body: JSON.stringify(expensePayload)
                });
            } else {
                await fetchApi('/expenses', {
                    method: 'POST',
                    body: JSON.stringify(expensePayload)
                });
            }

            await fetchAndRenderExpenses();
            hideExpenseForm();
        } catch (error) {
            alert(`Error submitting expense: ${error.message}`);
        }
    }

    async function handleExpenseAction(event) {
        const btn = event.target.closest('button[data-action]');
        if (!btn) return;

        const id = btn.getAttribute('data-id');
        const action = btn.getAttribute('data-action');
        const expense = state.expenses.find(e => e.id == id);

        if (!expense) return;

        if (action === 'edit') {
            showExpenseForm(true, expense);
        } else if (action === 'delete') {
            if (confirm(`Delete expense: ${expense.description}?`)) {
                try {
                    await fetchApi(`/expenses/${id}`, { method: 'DELETE' });
                    state.expenses = state.expenses.filter(e => e.id != id);
                    renderExpenses();
                } catch (error) {
                    alert(`Error deleting expense: ${error.message}`);
                }
            }
        }
    }

    // Initialize
    toggleAuthBtn.addEventListener('click', toggleAuthMode);
    authForm.addEventListener('submit', handleAuth);
    logoutBtn.addEventListener('click', handleLogout);
    addExpenseBtn.addEventListener('click', () => showExpenseForm(false, {}));
    formCancelBtn.addEventListener('click', hideExpenseForm);
    expenseForm.addEventListener('submit', handleExpenseSubmit);
    expenseList.addEventListener('click', handleExpenseAction);

    // Initial view
    if (state.token && state.userId) {
        showView(VIEWS.DASHBOARD);
    } else {
        showView(VIEWS.AUTH);
    }
</script>

</body>
</html>